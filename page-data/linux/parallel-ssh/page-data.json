{"componentChunkName":"component---src-templates-blog-template-js","path":"/linux/parallel-ssh","result":{"data":{"markdownRemark":{"html":"<p>I usually test on one machine, ensuring that all steps can be executed unnatended and then replicate them with parallel-ssh. For that thing we will need a list of all machines, but we will talk about it later (down the road).</p>\n<p>Be advised that all commands here are run from a root user. So first update the system.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> update\n<span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> upgrade</code></pre></div>\n<p>And here is the first obstacle when dpkg tries to interactively configure packages. It usually does that when you have a change in configuration file which is a part of that package. We want to keep our changes.</p>\n<p>At this point my ssh connection to the server died leaving configuration process running in the background. Remove all locks</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">rm</span> /var/lib/dpkg/lock-frontend\n<span class=\"token function\">rm</span> /var/lib/dpkg/lock\n<span class=\"token function\">rm</span> /var/cache/apt/archives/lock</code></pre></div>\n<p>If I run again <code class=\"language-text\">apt upgrade</code> or <code class=\"language-text\">dpkg --configure -a</code> or <code class=\"language-text\">apt-get --fix-broken install</code> I get this error message</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">debconf: DbDriver <span class=\"token string\">\"config\"</span><span class=\"token builtin class-name\">:</span> /var/cache/debconf/config.dat is locked by another process: Resource temporarily unavailable</code></pre></div>\n<p>Find that process and stop it:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">fuser</span> <span class=\"token parameter variable\">-v</span> /var/cache/debconf/config.dat\n<span class=\"token function\">kill</span> PID</code></pre></div>\n<p>Reference:</p>\n<ul>\n<li><a href=\"https://askubuntu.com/questions/136881/debconf-dbdriver-config-config-dat-is-locked-by-another-process-resource-t\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">https://askubuntu.com/questions/136881/debconf-dbdriver-config-config-dat-is-locked-by-another-process-resource-t</a></li>\n</ul>\n<p>But this time we will try to make configuration automatic by passing our choice \"keep the local version currently installed\" to dpkg</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token assign-left variable\">DEBIAN_FRONTEND</span><span class=\"token operator\">=</span>noninteractive <span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">-o</span> Dpkg::Options::<span class=\"token operator\">=</span><span class=\"token string\">\"--force-confold\"</span> <span class=\"token parameter variable\">-yq</span> upgrade</code></pre></div>\n<p>Reference:</p>\n<ul>\n<li><a href=\"https://unix.stackexchange.com/questions/332909/update-upgrade-debian-and-skip-any-interactions\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">https://unix.stackexchange.com/questions/332909/update-upgrade-debian-and-skip-any-interactions</a></li>\n<li>man dpkg</li>\n</ul>\n<p>Then clean some old kernels</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> autoremove</code></pre></div>\n<p>Then install NVidia proprietary video driver</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">ubuntu-drivers autoinstall</code></pre></div>\n<p>As a result on all other machines I will run</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-f</span> /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock\n<span class=\"token function\">apt</span> update\n<span class=\"token assign-left variable\">DEBIAN_FRONTEND</span><span class=\"token operator\">=</span>noninteractive <span class=\"token function\">apt-get</span> <span class=\"token parameter variable\">-o</span> Dpkg::Options::<span class=\"token operator\">=</span><span class=\"token string\">\"--force-confold\"</span> <span class=\"token parameter variable\">-yq</span> upgrade\n<span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> upgrade  <span class=\"token comment\"># explained later</span>\n<span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> autoremove</code></pre></div>\n<h3 id=\"list-of-hosts\" style=\"position:relative;\">List of hosts<a href=\"#list-of-hosts\" aria-label=\"list of hosts permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h3>\n<p>Now let's get a list of hosts. On all our clients I have ssh server on and running, so port 22 should be open:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">nmap <span class=\"token parameter variable\">-p</span> <span class=\"token number\">22</span> <span class=\"token number\">10.0</span>.0.0/24</code></pre></div>\n<p>Add some bash magic to get a nice list suitable for <code class=\"language-text\">parallel-ssh</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">nmap <span class=\"token parameter variable\">-oG</span> - <span class=\"token parameter variable\">-p</span> <span class=\"token number\">22</span> <span class=\"token number\">10.0</span>.0.0/24 <span class=\"token operator\">|</span> <span class=\"token function\">grep</span> <span class=\"token string\">\"Ports: 22/open\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">sed</span> <span class=\"token parameter variable\">-r</span> <span class=\"token parameter variable\">-e</span> <span class=\"token string\">'s/^Host: ([0-9\\.]+) \\(.*/\\1/'</span> <span class=\"token operator\">></span> list.txt\nparallel-ssh <span class=\"token parameter variable\">-h</span> list.txt <span class=\"token parameter variable\">-t</span> <span class=\"token number\">0</span> <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">IdentityFile</span><span class=\"token operator\">=</span>my_key <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">StrictHostKeyChecking</span><span class=\"token operator\">=</span>no <span class=\"token parameter variable\">-l</span> root <span class=\"token string\">'apt update'</span></code></pre></div>\n<h3 id=\"release-file-is-not-valid-yet\" style=\"position:relative;\">Release file is not valid yet<a href=\"#release-file-is-not-valid-yet\" aria-label=\"release file is not valid yet permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h3>\n<p>On some machines time was incorrect. How do I now that? I've got error code 100 from apt update. I ran apt update manually to see</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">Get:1 http://security.ubuntu.com/ubuntu bionic-security InRelease <span class=\"token punctuation\">[</span><span class=\"token number\">88.7</span> kB<span class=\"token punctuation\">]</span>\nHit:2 http://us.archive.ubuntu.com/ubuntu bionic InRelease\nGet:3 http://us.archive.ubuntu.com/ubuntu bionic-updates InRelease <span class=\"token punctuation\">[</span><span class=\"token number\">88.7</span> kB<span class=\"token punctuation\">]</span>\nReading package lists<span class=\"token punctuation\">..</span>. Done\nE: Release <span class=\"token function\">file</span> <span class=\"token keyword\">for</span> http://security.ubuntu.com/ubuntu/dists/bionic-security/InRelease is not valid yet <span class=\"token punctuation\">(</span>invalid <span class=\"token keyword\">for</span> another 1h 38min 45s<span class=\"token punctuation\">)</span>. Updates <span class=\"token keyword\">for</span> this repository will not be applied.\nE: Release <span class=\"token function\">file</span> <span class=\"token keyword\">for</span> http://us.archive.ubuntu.com/ubuntu/dists/bionic-updates/InRelease is not valid yet <span class=\"token punctuation\">(</span>invalid <span class=\"token keyword\">for</span> another 2h 48min 36s<span class=\"token punctuation\">)</span>. Updates <span class=\"token keyword\">for</span> this repository will not be applied.</code></pre></div>\n<p>But I knew how to fix that. I get correct time from the server and update it on all machines making sure that timezone is correct and fixing BIOS time</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">parallel-ssh <span class=\"token parameter variable\">-h</span> list.txt <span class=\"token parameter variable\">-t</span> <span class=\"token number\">0</span> <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">IdentityFile</span><span class=\"token operator\">=</span>my_key <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">StrictHostKeyChecking</span><span class=\"token operator\">=</span>no <span class=\"token parameter variable\">-l</span> root <span class=\"token string\">\"timedatectl set-ntp 1; timedatectl set-timezone America/Chicago; date -s <span class=\"token entity\" title=\"\\&quot;\">\\\"</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">date</span> <span class=\"token string\">'+%b %d %T %Y'</span><span class=\"token variable\">)</span></span><span class=\"token entity\" title=\"\\&quot;\">\\\"</span>; hwclock -w\"</span>\nparallel-ssh <span class=\"token parameter variable\">-i</span> <span class=\"token parameter variable\">-h</span> list.txt <span class=\"token parameter variable\">-t</span> <span class=\"token number\">0</span> <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">IdentityFile</span><span class=\"token operator\">=</span>my_key <span class=\"token parameter variable\">-O</span> <span class=\"token assign-left variable\">StrictHostKeyChecking</span><span class=\"token operator\">=</span>no <span class=\"token parameter variable\">-l</span> root <span class=\"token string\">'printf \"%s %s\\n\" \"$(hwclock -r)\" \"$(date)\"'</span></code></pre></div>\n<p>After that I still get 25 packages that were kept back not upgraded. For some reason apt-get ignored them. Because it already did all noninteractive work I tried its wrapper - apt</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">apt</span> <span class=\"token parameter variable\">-y</span> upgrade</code></pre></div>","excerpt":"I usually test on one machine, ensuring that all steps can be executed unnatended and then replicate them with parallel-ssh. For that thing…","tableOfContents":"<ul>\n<li><a href=\"#list-of-hosts\">List of hosts</a></li>\n<li><a href=\"#release-file-is-not-valid-yet\">Release file is not valid yet</a></li>\n</ul>","fields":{"socialcard":"gatsby-plugin-social-card/e0db827b-ae5c-55d1-86d1-980baa598378.jpg"},"frontmatter":{"date":"April 06, 2021","published":"October 14, 2021","lastModified":"October 14, 2021","title":"How to update 30 ubuntu machines connected to one network","subtitle":null,"section":null,"draft":null,"developing":null,"buttonText":null,"buttonLink":null,"secondButtonText":null,"secondButtonLink":null,"featuredImage":null}}},"pageContext":{"showLikes":true,"absolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/parallel-ssh.md","url":"/linux/parallel-ssh","next":{"excerpt":"Important! Some steps in this tutorial might be dangerous for your system. Step 1 - Make a backup We will send a backup over the network…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/lightweight-ubuntu.md","frontmatter":{"title":"Lightweight Ubuntu","date":"2021-06-04T00:00:00.000Z","topic":null,"article":null},"id":"d3b552b3-4789-555d-a010-a2a5f13a93df"},"previous":null,"recentArticles":[{"excerpt":"The time is now. So you are following the official path","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/lunar-vim.md","frontmatter":{"title":"Lunar Vim","date":"2025-07-12T00:00:00.000Z","topic":null,"article":null},"id":"96fd1359-d24f-593f-bfd5-c6ea877b7e1e"},{"excerpt":"Prologue When I changed my email with Asana, the service that I liked so much, I found it when I had trouble planning my day, forgiving…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/task-management-with-taskwarrior.md","frontmatter":{"title":"Task management with taskwarrior","date":"2025-06-19T00:00:00.000Z","topic":null,"article":null},"id":"d251091d-7777-5f57-a398-6317d95233da"},{"excerpt":"I called my pool 'dinosaur' and three datasets, you guessed it, triassic, jurassic, cretaceous Steps: Reference archwiki - zfs zfs handbook…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/encrypted-backup-with-zfs.md","frontmatter":{"title":"Encrypted backup with ZFS","date":"2025-06-10T00:00:00.000Z","topic":null,"article":null},"id":"a8cfe7c2-1870-5a4d-a4b6-a9e5cb56f73b"},{"excerpt":"I already got used to auto-starting services when they run with docker compose or docker stack, but I like it even more when the apps run…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/autostart-everything.md","frontmatter":{"title":"Autostart everything","date":"2025-05-26T00:00:00.000Z","topic":null,"article":null},"id":"7c1cd1ea-fc7f-558a-9576-5f5420866bad"},{"excerpt":"So this happened when I was working on a Go project and quite frequently compiled binaries for deployment in docker containers. I didn't pay…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/clear-space.md","frontmatter":{"title":"Clear space on Linux","date":"2025-04-15T00:00:00.000Z","topic":null,"article":null},"id":"b3347ef2-f534-5c29-bc5e-0ed82ca4c7ee"}]}},"staticQueryHashes":["2961657013","447685113"],"slicesMap":{}}