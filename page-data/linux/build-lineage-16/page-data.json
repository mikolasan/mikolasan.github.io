{"componentChunkName":"component---src-templates-blog-template-js","path":"/linux/build-lineage-16","result":{"data":{"markdownRemark":{"html":"<p>Here is the story of how I continued <a href=\"/linux/upgrade-android-on-nvidia-shield\">upgrading Android on my Nvidia Shield tablet</a> because one day I saw a popup in the app, where I read ebooks from my public library, that soon they will drop support of Android 7.</p>\n<h2 id=\"setup-docker\" style=\"position:relative;\">Setup Docker<a href=\"#setup-docker\" aria-label=\"setup docker permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>Docker setup is the same as for <a href=\"/linux/build-lineage-15\">Lineage 15 build</a></p>\n<p>I just wiped the whole <code class=\"language-text\">/lineage/</code> folder. Maybe there is a better way. Something like</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token builtin class-name\">cd</span> /lineage\n<span class=\"token function\">make</span> clean\nrepo init <span class=\"token parameter variable\">-b</span> lineage-16.0\nrepo <span class=\"token function\">sync</span> --force-sync --force-remove-dirty</code></pre></div>\n<p>Repo <a href=\"https://source.android.com/docs/setup/create/repo#init\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">command reference</a>. But most likely it will fail. So I just repeat from the beginning with another branch</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">rm</span> <span class=\"token parameter variable\">-r</span> /lineage\n<span class=\"token function\">mkdir</span> /lineage\n<span class=\"token builtin class-name\">cd</span> /lineage\nrepo init <span class=\"token parameter variable\">-u</span> https://github.com/LineageOS/android.git <span class=\"token parameter variable\">-b</span> lineage-16.0 --git-lfs</code></pre></div>\n<p>Then we follow the <a href=\"https://wiki.lineageos.org/devices/shieldtablet/build\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">build instructions</a>. And very soon the <code class=\"language-text\">breakfast shieldtablet</code> command spits these errors.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">build/make/core/product_config.mk:234: error: Can not locate config makefile for product \"lineage_shieldtablet\".\n\n...\n\nframeworks/native/build/phone-xhdpi-2048-dalvik-heap.mk:20: error: _nic.PRODUCTS.[[device/nvidia/shieldtablet/lineage_shieldtablet.mk]]: \"vendor/nvidia/shieldtablet/shieldtablet-vendor.mk\" does not exist.\n\n...\n\n** Don't have a product spec for: 'lineage_shieldtablet'\n** Do you have the right repo manifest?</code></pre></div>\n<h2 id=\"about-project-structure\" style=\"position:relative;\">About project structure<a href=\"#about-project-structure\" aria-label=\"about project structure permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>Also there is no <code class=\"language-text\">extract-files.sh</code> script in <code class=\"language-text\">device/nvidia/shieldtablet</code> folder. Because of that some folders do not exist and <code class=\"language-text\">breakfast</code> fails. For example</p>\n<ul>\n<li>makefiles Android.mk, BoardConfigVendor.mk, shieldtablet-vendor.mk in <code class=\"language-text\">vendor/nvidia/shieldtablet</code></li>\n<li>directory <code class=\"language-text\">vendor/nvidia/shieldtablet/proprietary</code></li>\n<li><code class=\"language-text\">etc</code>, <code class=\"language-text\">vendor</code> in <code class=\"language-text\">proprietary</code></li>\n</ul>\n<p>They say that you need to become familiar with the <code class=\"language-text\">repo</code> tool. They send you to the official <a href=\"https://source.android.com/docs/setup/download\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">Getting started</a> page. But I guarantee you, they won't tell you all shortcuts that normal people would use. So let's begin.</p>\n<p><code class=\"language-text\">repo</code> is like Git Submodules, but for some reason no one likes submodules. When you run <code class=\"language-text\">repo sync</code> for the first time, it dowloads many repositories and orginizes them in directories and subdirectories. This organization is conformed with the build system, which means that it composes a huge build tree for you.</p>\n<p>This process can be more transparent and customizable. There is at least one tool that serves very similar purpose, and this is the tool that I very like - <a href=\"/linux/custom-linux-distro\">Buildroot</a>. It has very tiny repository. It's basically a set of Makefiles and scripts which create full Linux-based operating system. All components like applications, tools, frameworks, libraries, drivers and so on, it downloads from public repositories, then compiles, then puts it together into the image of your choise like tar archive, cpio ramfs, or ISO. But because you can select a subset of tools from the whole variety of open source projects, thus it downloads only that subset. On the other side, Android seems very monolithic, it downloads everything and all this tools always in the image.</p>\n<p>In order to review the build system I need to find the originating script <code class=\"language-text\">build/make/core/product_config.mk</code> and review actions from the <code class=\"language-text\">breakfast</code> command.</p>\n<p>In the root directory there is a hidden  folder, <code class=\"language-text\">.repo</code>. In the main manifest file (a thing similar to <code class=\"language-text\">.gitmodules</code>) search for <code class=\"language-text\">build/make</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">grep</span> build/make .repo/manifests/default.xml</code></pre></div>\n<p>And you find that you need <a href=\"https://github.com/LineageOS/android_build/tree/lineage-16.0\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">android_build</a> repository. Then we locate the <a href=\"https://github.com/LineageOS/android_build/blob/lineage-16.0/core/product_config.mk#L234\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">source</a> of our error.</p>\n<p>And you know what? Makefiles are scary. But from my supeficial lookup I can tell that it creates a list of products by finding <code class=\"language-text\">$(SRC_TARGET_DIR)/product/AndroidProducts.mk</code> files. This error is safe to ignore because this is how it reilizes that it need to download <a href=\"https://github.com/LineageOS/android_device_nvidia_shieldtablet/tree/lineage-16.0\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">android_device_nvidia_shieldtablet</a></p>\n<p>Here's device specific manifest <code class=\"language-text\">.repo/local_manifests/roomservice.xml</code> that defines many repositories for Nvidia components</p>\n<div class=\"gatsby-highlight\" data-language=\"xml\"><pre class=\"language-xml\"><code class=\"language-xml\"><span class=\"token prolog\">&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>manifest</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_shieldtablet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/shieldtablet<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_icera<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/icera<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_t124-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/t124-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_touch<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/touch<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_shield-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/shield-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_kernel_nvidia_shield<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>kernel/nvidia/shield<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_hardware_nvidia_interfaces<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hardware/nvidia/interfaces<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_hardware_nvidia_light<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hardware/nvidia/light<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_hardware_nvidia_memtrack<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hardware/nvidia/memtrack<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_hardware_nvidia_power<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hardware/nvidia/power<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_hardware_nvidia_thermal<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>hardware/nvidia/thermal<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>project</span> <span class=\"token attr-name\">name</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>LineageOS/android_device_nvidia_tegra-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">path</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>device/nvidia/tegra-common<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">remote</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>github<span class=\"token punctuation\">\"</span></span> <span class=\"token punctuation\">/></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>manifest</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>I think this step with extracting proprietary files can be done better, but for now I just copy the <code class=\"language-text\">system</code> archive from previous build. Extract archive</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">tar</span> xvf /system.tar.gz <span class=\"token parameter variable\">-C</span> /system_dump/ --numeric-owner\n<span class=\"token builtin class-name\">cd</span> device/nvidia/shieldtablet/\n./extract-files.sh /system_dump/</code></pre></div>\n<h2 id=\"libnvphs\" style=\"position:relative;\">libnvphs<a href=\"#libnvphs\" aria-label=\"libnvphs permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>And brunch time! Oh no, not again</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">hardware/nvidia/power/Android.mk: error: \"vendor.nvidia.hardware.power@1.0-service (EXECUTABLES android-arm) missing libnvphs (SHARED_LIBRARIES android-arm)\"</code></pre></div>\n<p>Ok, this library, <code class=\"language-text\">libnvphs</code> I can find in <a href=\"https://github.com/TheMuppets/proprietary_vendor_nvidia/tree/lineage-16.0/shield\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">proprietary_vendor_nvidia</a> repository. Which means I need to fix proprietary files manually again.</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">git</span> clone <span class=\"token parameter variable\">-b</span> lineage-16.0 --single-branch https://github.com/TheMuppets/proprietary_vendor_nvidia.git /proprietary_vendor_nvidia\n<span class=\"token function\">cp</span> <span class=\"token parameter variable\">-v</span> /proprietary_vendor_nvidia/t124/nvphs/lib/libnvphs.so /lineage/vendor/nvidia/shieldtablet/proprietary/vendor/lib/</code></pre></div>\n<p>I check <a href=\"https://gitlab.incom.co/CM-Shield/android_hardware_nvidia_power/-/blob/lineage-16.0/Android.mk?ref_type=heads\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">that makefile</a> and trying to find where other libraries are located</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">find</span> <span class=\"token builtin class-name\">.</span> <span class=\"token parameter variable\">-type</span> f <span class=\"token parameter variable\">-name</span> <span class=\"token string\">\"libhardware.so\"</span></code></pre></div>\n<p>It appears that they all are part of <code class=\"language-text\">platform/prebuilts/vndk/v27</code> <a href=\"https://android.googlesource.com/platform/prebuilts/vndk/v27/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">link</a>. Of course proprietary Nvidia library will be missing.</p>\n<p>According to <a href=\"https://gitlab.incom.co/CM-Shield/android_device_nvidia_tegra-common/-/blob/lineage-18.1/extract/file.list\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">this</a> list I conclude that libnvphs was introduced in new versions of Shield tablet. So I comment out that line in the makefile that requires the library. It could fail during linkage with many undefined reference errors or, as before with files in proprietary blobs, it's just extra (or leftover) from another models.</p>\n<p>It did fail (output split into lines by me):</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[ 98% 72880/73717] target Executable: ven...vendor.nvidia.hardware.power@1.0-service)\nFAILED: /lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/LINKED/vendor.nvidia.hardware.power@1.0-service\n\n/bin/bash -c \"/usr/bin/ccache prebuilts/clang/host/linux-x86/clang-4691093/bin/clang++ \n-pie -nostdlib -Bdynamic -Wl,-dynamic-linker,/system/bin/linker -Wl,--gc-sections -Wl,-z,nocopyreloc \n-Wl,-rpath-link=/lineage/out/target/product/shieldtablet/obj/lib \n\n/lineage/out/target/product/shieldtablet/obj/lib/crtbegin_dynamic.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/service.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/Power.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/nvpowerhal.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/timeoutpoker.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/powerhal_parser.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/powerhal_utils.o \n/lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/tegra_sata_hal.o \n\n-Wl,--whole-archive  -Wl,--no-whole-archive   \n/lineage/out/target/product/shieldtablet/obj/STATIC_LIBRARIES/libunwind_llvm_intermediates/libunwind_llvm.a  \n/lineage/out/target/product/shieldtablet/obj/STATIC_LIBRARIES/libclang_rt.ubsan_minimal-arm-android_intermediates/libclang_rt.ubsan_minimal-arm-android.a  \n/lineage/out/target/product/shieldtablet/obj/STATIC_LIBRARIES/libcompiler_rt-extras_intermediates/libcompiler_rt-extras.a   \n/lineage/out/target/product/shieldtablet/obj/STATIC_LIBRARIES/libatomic_intermediates/libatomic.a \n/lineage/out/target/product/shieldtablet/obj/STATIC_LIBRARIES/libgcc_intermediates/libgcc.a \n\n-Wl,-z,noexecstack -Wl,-z,relro -Wl,-z,now -Wl,--build-id=md5 -Wl,--warn-shared-textrel \n-Wl,--fatal-warnings -Wl,--no-undefined-version -Wl,--icf=safe -Wl,--hash-style=gnu -Wl,-m,armelf -Wl,--no-fix-cortex-a8   \n\n-target arm-linux-androideabi \n-Bprebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9/arm-linux-androideabi/bin \n-Wl,--exclude-libs,libunwind_llvm.a \n-Wl,--exclude-libs,libclang_rt.ubsan_minimal-arm-android.a \n-Wl,--no-undefined \n\n/lineage/out/target/product/shieldtablet/obj/lib/libhardware.so \n/lineage/out/target/product/shieldtablet/obj/lib/libhidlbase.so \n/lineage/out/target/product/shieldtablet/obj/lib/libhidltransport.so \n/lineage/out/target/product/shieldtablet/obj/lib/liblog.so \n/lineage/out/target/product/shieldtablet/obj/lib/libcutils.so \n/lineage/out/target/product/shieldtablet/obj/lib/libutils.so \n/lineage/out/target/product/shieldtablet/obj/lib/libexpat.so \n/lineage/out/target/product/shieldtablet/obj/lib/vendor.nvidia.hardware.power@1.0.so \n/lineage/out/target/product/shieldtablet/obj/lib/libc++.so \n/lineage/out/target/product/shieldtablet/obj/lib/libc.so \n/lineage/out/target/product/shieldtablet/obj/lib/libm.so \n/lineage/out/target/product/shieldtablet/obj/lib/libdl.so \n\n-o /lineage/out/target/product/shieldtablet/obj/EXECUTABLES/vendor.nvidia.hardware.power@1.0-service_intermediates/LINKED/vendor.nvidia.hardware.power@1.0-service \n/lineage/out/target/product/shieldtablet/obj/lib/crtend_android.o\"\n\n\nhardware/nvidia/power/nvpowerhal.cpp:796: error: undefined reference to 'NvPHSCancelThroughputHints'\nhardware/nvidia/power/nvpowerhal.cpp:793: error: undefined reference to 'NvPHSSendThroughputHints'\nclang-6.0: error: linker command failed with exit code 1 (use -v to see invocation)</code></pre></div>\n<p>Function <code class=\"language-text\">NvPHSCancelThroughputHints</code> <a href=\"https://github.com/LineageOS/android_hardware_nvidia_power/blob/5c87ad184e67418b2e064ea8ece72fcdedec520c/nvpowerhal.cpp#L796\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">is called</a> but needs a library\n(<a href=\"https://gitlab.incom.co/CM-Shield/android_hardware_nvidia_power/-/blob/lineage-20.0/nvpowerhal.cpp#L796\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">gitlab mirror</a>).\nSo where to put that library?</p>\n<p>One easy solution is this:</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\"><span class=\"token comment\">#ifeq ($(TARGET_TEGRA_PHS),nvphs)</span>\n<span class=\"token comment\">#    LOCAL_CFLAGS += -DUSE_NVPHS</span>\n<span class=\"token comment\">#    LOCAL_SHARED_LIBRARIES += libnvphs</span>\n<span class=\"token comment\">#endif</span></code></pre></div>\n<p>Yes, just comment out this part where the flag is set and the library added to the list.</p>\n<p>Another solution is to follow <a href=\"https://developer.android.com/ndk/guides/prebuilts\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">this guide</a>. Actually I found an example first in <a href=\"https://github.com/LineageOS/android_hardware_nvidia_sensors/blob/lineage-16.0/Android.mk\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">this repo</a></p>\n<p>And a third option is</p>\n<ul>\n<li>download <code class=\"language-text\">libnvphs.so</code> from <a href=\"https://github.com/BigTopKrazies/vendor_nvidia/tree/8.1/shield/common/lib\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">this repo</a></li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token function\">wget</span> <span class=\"token parameter variable\">-O</span> /system_dump/system/vendor/lib/libnvphs.so https://github.com/BigTopKrazies/vendor_nvidia/raw/8.1/shield/common/lib/libnvphs.so</code></pre></div>\n<ul>\n<li>add to <code class=\"language-text\">device/nvidia/shieldtablet/proprietary-files.txt</code> this line</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">vendor/lib/libnvphs.so</code></pre></div>\n<p>I don't know what path to specify</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">OUT is obsolete. Use OUT_DIR instead. See https://android.googlesource.com/platform/build/+/master/Changes.md#OUT</code></pre></div>\n<p>So, I'd rather puth in the <code class=\"language-text\">$(LOCAL_PATH)</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">cp /system_dump/system/vendor/lib/libnvphs.so /lineage/hardware/nvidia/power/</code></pre></div>\n<p>New error (when BUILD_SHARED_LIBRARY)</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">libnvphs: Unused source files: hardware/nvidia/power/libnvphs.so</code></pre></div>\n<p>Means ...</p>\n<blockquote>\n<p><code class=\"language-text\">brunch</code> is just <code class=\"language-text\">breakfast + mka bacon</code> - you can do it manually.</p>\n</blockquote>\n<h2 id=\"upgrade-to-androidbp\" style=\"position:relative;\">Upgrade to Android.bp<a href=\"#upgrade-to-androidbp\" aria-label=\"upgrade to androidbp permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>What I usually do, I search for similar use cases and try to copy how someone already did it</p>\n<p>But strangely I don't see Android.mk files, I see is Android.bp files - this is <a href=\"https://android.googlesource.com/platform/build/soong/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">a new format</a>. <a href=\"https://stackoverflow.com/questions/51207766/where-can-i-find-androidmk-tool-to-convert-android-mk-to-android-bp\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">There is a tool</a> that can convert <code class=\"language-text\">mk</code> files to <code class=\"language-text\">bp</code></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># build a tool</span>\n<span class=\"token function\">make</span> blueprint_tools\n<span class=\"token comment\"># convert to new format</span>\n<span class=\"token builtin class-name\">cd</span> hardware/nvidia/power/\nandroidmk Android.mk <span class=\"token operator\">></span> Android.bp</code></pre></div>\n<p>The downside of bp format: it doesn’t have fancy string manipulation stuff like</p>\n<div class=\"gatsby-highlight\" data-language=\"makefile\"><pre class=\"language-makefile\"><code class=\"language-makefile\">LOCAL_CFLAGS <span class=\"token operator\">+=</span> -DTARGET_TEGRA_VERSION<span class=\"token operator\">=</span><span class=\"token variable\">$</span><span class=\"token punctuation\">(</span>TARGET_TEGRA_VERSION<span class=\"token punctuation\">:</span>t<span class=\"token operator\">=</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>and not supporting conditionals.</p>\n<p>The build script will look like this (but I didn't test it)</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">cc_binary <span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">\"powerhal.tegra\"</span><span class=\"token punctuation\">,</span>\n\n    cflags<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"-DGPU_IS_LEGACY\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"-DPOWER_MODE_SET_INTERACTIVE\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"-DUSE_NVPHS\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"-DLINEAGE_PROFILES\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\n    srcs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"service.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Power.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"nvpowerhal.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"timeoutpoker.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"powerhal_parser.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"powerhal_utils.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"tegra_sata_hal.cpp\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token comment\">// \"power_floor_t210.cpp\"</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    shared_libs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token string\">\"libhardware\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libhidlbase\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libhidltransport\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"liblog\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libcutils\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libutils\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libdl\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libexpat\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"vendor.nvidia.hardware.power@1.0\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"libnvphs\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"vendor.lineage.power@1.0\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n\n    init_rc<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"vendor.nvidia.hardware.power@1.0-service.rc\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    intf_fragments<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"vendor.nvidia.hardware.power@1.0-service.xml\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    relative_install_path<span class=\"token operator\">:</span> <span class=\"token string\">\"hw\"</span><span class=\"token punctuation\">,</span>\n    vendor<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    owner<span class=\"token operator\">:</span> <span class=\"token string\">\"nvidia\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"stuck-on-boot\" style=\"position:relative;\">Stuck on boot<a href=\"#stuck-on-boot\" aria-label=\"stuck on boot permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>My build finished, but it stuck on boot logo. I found <a href=\"https://forum.xda-developers.com/t/how-get-boot-log-of-fresh-builded-lineage-of-device-stucks-on-boot-animation.4077827/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">a forum post</a> precisely describing my problem. No answer.</p>\n<p>Where to find logs?</p>\n<ul>\n<li>I tried <code class=\"language-text\">adb logcat</code> - nothing</li>\n<li>Maybe I should build ROM again, but this time disable some security features: <code class=\"language-text\">persist.sys.usb.config=mtp,ad ro.secure=0 ro.adb.secure=0</code> (<a href=\"https://android.stackexchange.com/questions/221431/how-to-see-the-boot-progress-messages-akin-to-dmesg-when-booting-lineageos\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">link</a>). But then the question about messing with <code class=\"language-text\">boot.img</code> is another headache. <a href=\"https://www.whitewinterwolf.com/posts/2016/08/11/how-to-unpack-and-edit-android-boot-img/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">Unpack <code class=\"language-text\">boot.img</code></a>, and then <a href=\"https://android.stackexchange.com/questions/169528/device-does-not-boot-to-system-after-flashing-boot-image?rq=1\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">pack it back</a></li>\n<li>I tried to find previous boot log in <code class=\"language-text\">/proc/last_kmsg</code> from TWRP.</li>\n<li>But in my version it probably will use <code class=\"language-text\">pstore</code> (<a href=\"https://android.stackexchange.com/questions/213336/how-can-i-enable-last-kmsg\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">link</a>). Or should I say <em>definitely!</em>, because Lineage 15 uses kernel <strong>3.10.96+</strong>, and <code class=\"language-text\">pstore</code> is enabled in kernel >3.4 (<a href=\"https://docs.halium.org/en/latest/porting/debug-build/dmesg.html\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">link</a>)</li>\n<li>But maybe some stuff should be mounted manually (<a href=\"https://github.com/torvalds/linux/blob/v5.1/Documentation/admin-guide/ramoops.rst#reading-the-data\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">link</a>)</li>\n</ul>\n<p>Or should I try prebuilt versions, like the ones <a href=\"https://sourceforge.net/projects/andyyan-gsi/files/lineage-16.x/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">from Andy Yan</a>?</p>\n<p>Well, I started <a href=\"/linux/build-android-gsi-10\">building GSI</a>.</p>","excerpt":"Here is the story of how I continued upgrading Android on my Nvidia Shield tablet because one day I saw a popup in the app, where I read…","tableOfContents":"<ul>\n<li><a href=\"#setup-docker\">Setup Docker</a></li>\n<li><a href=\"#about-project-structure\">About project structure</a></li>\n<li><a href=\"#libnvphs\">libnvphs</a></li>\n<li><a href=\"#upgrade-to-androidbp\">Upgrade to Android.bp</a></li>\n<li><a href=\"#stuck-on-boot\">Stuck on boot</a></li>\n</ul>","fields":{"socialcard":"gatsby-plugin-social-card/b4b3a0f7-e09c-5c6f-bcd0-74e7ec0ad8c0.jpg"},"frontmatter":{"date":"June 27, 2023","published":"June 27, 2023","lastModified":"June 27, 2023","title":"Build Lineage 16","subtitle":null,"section":null,"draft":null,"developing":null,"buttonText":null,"buttonLink":null,"secondButtonText":null,"secondButtonLink":null,"featuredImage":null}}},"pageContext":{"showLikes":true,"absolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/build-lineage-16.md","url":"/linux/build-lineage-16","next":{"excerpt":"I hate Reddit and forums. Especially popular forums like XDA, the source of unique and valuable information and good advice. But. All…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/build-android-gsi-10.md","frontmatter":{"title":"Build Android GSI","date":"2023-07-06T00:00:00.000Z","topic":null,"article":null},"id":"349a597e-6256-537b-acf3-2b3530020f2c"},"previous":{"excerpt":"Here is the story of how I started upgrading Android on my Nvidia Shield tablet because one day I saw a popup in the app, where I read…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/build-lineage-15.md","frontmatter":{"title":"Build Lineage 15","date":"2023-06-20T00:00:00.000Z","topic":null,"article":null},"id":"90a161b4-c9da-5a0d-bdad-0d608fb7f9dd"},"recentArticles":[{"excerpt":"The time is now. So you are following the official path","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/lunar-vim.md","frontmatter":{"title":"Lunar Vim","date":"2025-07-12T00:00:00.000Z","topic":null,"article":null},"id":"96fd1359-d24f-593f-bfd5-c6ea877b7e1e"},{"excerpt":"Prologue When I changed my email with Asana, the service that I liked so much, I found it when I had trouble planning my day, forgiving…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/task-management-with-taskwarrior.md","frontmatter":{"title":"Task management with taskwarrior","date":"2025-06-19T00:00:00.000Z","topic":null,"article":null},"id":"d251091d-7777-5f57-a398-6317d95233da"},{"excerpt":"I called my pool 'dinosaur' and three datasets, you guessed it, triassic, jurassic, cretaceous Steps: Reference archwiki - zfs zfs handbook…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/encrypted-backup-with-zfs.md","frontmatter":{"title":"Encrypted backup with ZFS","date":"2025-06-10T00:00:00.000Z","topic":null,"article":null},"id":"a8cfe7c2-1870-5a4d-a4b6-a9e5cb56f73b"},{"excerpt":"I already got used to auto-starting services when they run with docker compose or docker stack, but I like it even more when the apps run…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/autostart-everything.md","frontmatter":{"title":"Autostart everything","date":"2025-05-26T00:00:00.000Z","topic":null,"article":null},"id":"7c1cd1ea-fc7f-558a-9576-5f5420866bad"},{"excerpt":"So this happened when I was working on a Go project and quite frequently compiled binaries for deployment in docker containers. I didn't pay…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/linux/clear-space.md","frontmatter":{"title":"Clear space on Linux","date":"2025-04-15T00:00:00.000Z","topic":null,"article":null},"id":"b3347ef2-f534-5c29-bc5e-0ed82ca4c7ee"}]}},"staticQueryHashes":["2961657013","447685113"],"slicesMap":{}}