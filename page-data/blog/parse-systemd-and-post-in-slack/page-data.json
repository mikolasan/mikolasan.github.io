{"componentChunkName":"component---src-templates-blog-template-js","path":"/blog/parse-systemd-and-post-in-slack","result":{"data":{"markdownRemark":{"html":"<p>I found logagent from a google search. It should solve a very simple thing: get logs from systemd, focus on one service, format a message and send to Slack with webhooks. After six months I have found some time to make another effort and make it finally work.</p>\n<h2 id=\"preface\" style=\"position:relative;\">Preface<a href=\"#preface\" aria-label=\"preface permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>For example you have a very small software company. You are using only free services and you do not have resources to write custom solutions.</p>\n<p>When you work with real users, anything can happen. You have a system that requires constant monitoring. Normally one will setup alerts, but you do not know what alerts you need.</p>\n<p>Then you decide to keep an eye on it, set a simple service redirecting important log messages into Slack, that way your managers can spot a problem and later formulate what alerts they need.</p>\n<h2 id=\"install-logagent\" style=\"position:relative;\">Install logagent<a href=\"#install-logagent\" aria-label=\"install logagent permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>First thing first, get the code</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">git clone https://github.com/sematext/logagent-js.git\ngit rev-parse HEAD\naf1661efcb69812bc495524cbc07a1c55e0767ec</code></pre></div>\n<p>Commit <code class=\"language-text\">af1661efcb69812bc495524cbc07a1c55e0767ec</code> is the place of my investigation. Also</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">node --version\nv16.0.0\nnpm --version\n7.11.2</code></pre></div>\n<p>install modules from npm</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install</code></pre></div>\n<p>Here is my first error.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; flex:1.7717391304347827;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ab82596002fbf4d9784983f949499983/29114/logagent-js-npm-install.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44171779141104%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACQUlEQVR42kWS3W7iMBSE00LiOE5i5w9CkgJNCdBCqRpYVUjbvsHu1arX+/4vMTt2K+3FKPzEc+Z8Y+9tfMHz8RnDcI/dbkDf36PrGrRtw2fn1NRzmEQhjiRkGCKNFXIdI0sVCq1Q5RpNpbEqBbzX4wmX8xnnywWHwwHb7Q5N01LWtEVd16gKjVIniGUIfzpFIgWNImSJhE4iDuMQSsUhvMvLC87jiHF8xX6/x363xXLZoZ7PMKsKmDTmAR6KJVIZ0HBCY0Ej6WSY0BiFNI2Q0NR73j/hab+l2YDt0GPY3GO1bNEuZkyWIWMyGQq3csk1hT+FCgNk2ZeRZtI0lYhViCgK4H1cX3E67LjuQIYPWK/vMJ8XKErDlKVLqGlWlzmKTJNfRJYCmfk2opQSiKQPEfrw/v55x/XHiYaPWK86mlWcnPBlwi4MQhE4qSiE5LPg71n8P1GkfCcRTOH7E3ifv37i/fqGCzkeHndc+wEN153NCtTUjGublIXEsZMdcrcoUbDZioxLi4UBdKpcEO/z9weubHg8jzgeHx1Le302m57lNNhuHtCvV6jKgtw0NA9VWYKc/OLErmsVchjXJgrvdNxjzRK6rnapyu+DVlWVMe2C4DVflihM6po0bDRnu5EKICMfkvzC0DKcwuv7NZbdHG2dufuW5Xay4NQAqb28xkCQ3c3tDTn5SMhPRV//WyNJjrYMW4r97rlrcjfHojaYzQ1M/jXZSrHRSCkENLqdTDChbApnJKfus00WCCYUU5oK/AMvjQ/zigi0AgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logagent js npm install\"\n        title=\"\"\n        src=\"/static/ab82596002fbf4d9784983f949499983/a6d36/logagent-js-npm-install.png\"\n        srcset=\"/static/ab82596002fbf4d9784983f949499983/222b7/logagent-js-npm-install.png 163w,\n/static/ab82596002fbf4d9784983f949499983/ff46a/logagent-js-npm-install.png 325w,\n/static/ab82596002fbf4d9784983f949499983/a6d36/logagent-js-npm-install.png 650w,\n/static/ab82596002fbf4d9784983f949499983/e548f/logagent-js-npm-install.png 975w,\n/static/ab82596002fbf4d9784983f949499983/3c492/logagent-js-npm-install.png 1300w,\n/static/ab82596002fbf4d9784983f949499983/29114/logagent-js-npm-install.png 1920w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Flag <code class=\"language-text\">--force</code> makes it swallow the pill</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">npm install --force</code></pre></div>\n<p>Let's ignore deprecated warnings, we will fix it later. Now it's time to check the \"binary\":</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">node ./bin/logagent -h </code></pre></div>\n<p>Great! After this we can continue with the <a href=\"https://sematext.com/docs/logagent/how-to-centralize-linux-system-journal/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">official tutorial</a> on how to forward systemd logs to sematext (output from sematext will be configured in the second stage).</p>\n<p>The howto has good explanations that I'm not going to repeat. I will only list here the steps you need to make everything work.</p>\n<h2 id=\"configure-logagent\" style=\"position:relative;\">Configure logagent<a href=\"#configure-logagent\" aria-label=\"configure logagent permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>Create example config file</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">node ./bin/logagent --writeConfig logagent.yml</code></pre></div>\n<p>It is huge! It has 1085 lines. Okay, just make a new one, we keep it simple:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">input</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">journal-upload</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">-</span>journald<span class=\"token punctuation\">-</span>upload\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9090</span>\n    <span class=\"token key atrule\">worker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">systemdUnitFilter</span><span class=\"token punctuation\">:</span> \n      <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!!js/regexp</span> /.<span class=\"token important\">*/i</span>\n    <span class=\"token key atrule\">removeFields</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> __CURSOR\n      <span class=\"token punctuation\">-</span> _TRANSPORT\n      <span class=\"token punctuation\">-</span> _BOOT_ID\n      <span class=\"token punctuation\">-</span> _UID\n      <span class=\"token punctuation\">-</span> _GID\n      <span class=\"token punctuation\">-</span> _CAP_EFFECTIVE\n      <span class=\"token punctuation\">-</span> _MACHINE_ID\n      <span class=\"token punctuation\">-</span> _HOSTNAME\n      <span class=\"token punctuation\">-</span> _SYSTEMD_SLICE\n      <span class=\"token punctuation\">-</span> _STREAM_ID\n      <span class=\"token punctuation\">-</span> _PID\n      <span class=\"token punctuation\">-</span> _COMM\n      <span class=\"token punctuation\">-</span> _EXE\n      <span class=\"token punctuation\">-</span> _CMDLINE\n      <span class=\"token punctuation\">-</span> _SYSTEMD_CGROUP\n      <span class=\"token punctuation\">-</span> _SYSTEMD_INVOCATION_ID\n      <span class=\"token punctuation\">-</span> SYSLOG_FACILITY\n      <span class=\"token punctuation\">-</span> PRIORITY\n      <span class=\"token punctuation\">-</span> SYSLOG_IDENTIFIER\n\n<span class=\"token key atrule\">output</span><span class=\"token punctuation\">:</span> \n  <span class=\"token key atrule\">stdout</span><span class=\"token punctuation\">:</span> yaml</code></pre></div>\n<p>More about configuration options of <code class=\"language-text\">input-journald-upload</code> in input plugin spec: <a href=\"https://sematext.com/docs/logagent/input-plugin-journald-upload/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">https://sematext.com/docs/logagent/input-plugin-journald-upload/</a></p>\n<p>Run the logagent. This will start a web server on our localhost on port 9090 waiting for journal info to come. Keep this terminal open.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">node ./bin/logagent --config logagent.yml</code></pre></div>\n<h2 id=\"send-systemd-logs-to-logagent\" style=\"position:relative;\">Send systemd logs to logagent<a href=\"#send-systemd-logs-to-logagent\" aria-label=\"send systemd logs to logagent permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>There is no such package as <code class=\"language-text\">systemd-journal-remote</code> on Arch. This thing is already in the system:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">pacman -Qo /usr/lib/systemd/system/systemd-journal-upload.service\n/usr/lib/systemd/system/systemd-journal-upload.service is owned by systemd 247.6-1.0</code></pre></div>\n<p>So just add this URL <code class=\"language-text\">URL=http://127.0.0.1:9090/00000000-0000-0000-0000-000000000000</code> to <code class=\"language-text\">/etc/systemd/journal-upload.conf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo vim /etc/systemd/journal-upload.conf</code></pre></div>\n<p>Be carefull with instructions in the howto, their URL has a comma... and missing a token (which is some UUID, but we do only local work, so no need to create free account, because any UUID should be fine - I use zeroes). I figured that out from the source code (somewhere in <a href=\"https://github.com/sematext/logagent-js/blob/8add66df1ba1e250266f2622c500b3f4c9012367/lib/plugins/input/journald-upload.js#L266\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">these lines</a> when I searched for \"invalid logs token in url\" message).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 650px; flex:1.8735632183908046;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1b8b99f7631939932a412662c906f447/8d68c/logagent-howto-comma.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37423312883436%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAACTUlEQVR42l2R204TURSG5zEkJj0AbSkaCZIUJVAFMfHCC9/AW6+98gV8Bt/BdxABOVWipa0BZKKxHZrQ05xn9rTdM79rrxYv3MmXtfaetf/9rzXa8mpZLpfW5Vp5W66tb8qFhSJTLC4yk/0ik8sVZDqVkel0Vmays3J+Pi+zs3NyZubuOJPOYjaVudCWtl/hYfk5Ug9WMbeyjsLqJvKlp8hTLDzaQq70BLmVMvIbW9h4/wbbH96i9O417j1+RmyhWNpA6v5KcqewhPKLl7p2+esP2jdd6L+bqDbOsbN/gP2jY+IEuwdHHL8cV7B7eITKRR2VqzpOLxs4/6kTVzj9XkXtx3miNHb29nUtDAKoFVDs93vodG7g+x6GUQQhQkRCTPKQ8mDCaDjkO1EkqNanOpGo/dlZVdf6gwF/9PwApmVR9DEwHZimRdGEZduEww9GJJwkCcbjMcZSglVoSSk5rdfrJNjv82FIDiwSVNHzfH7Z8zzGdV14BEfakwCjFj8wGrFgQwkqAbWGoxFU+/2Bg55twXTJmevwmRJXKJeqnlpk8J/DWq2ma8F0hiMlSMU2tafGoNo1Cduy2bliOi8WvhUM7AEaJ59Z8KRS0TU1l1vBYOrGddxpy5RTi47jIKIfEcfxZH6ElGOEYohms4nat69JLOOJw3a7/a9IzUfNtNvtclT0ej1mQK6VSxWVc1Wv5hcnMbfcJVOH1TNd63Q6gpwJciSoWNADotlqiZZhiFbLEMb1NeeGcc3wNzon10KtMBR03w8/Ge34485e4y9NueXRqLizbAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"logagent howto comma\"\n        title=\"\"\n        src=\"/static/1b8b99f7631939932a412662c906f447/a6d36/logagent-howto-comma.png\"\n        srcset=\"/static/1b8b99f7631939932a412662c906f447/222b7/logagent-howto-comma.png 163w,\n/static/1b8b99f7631939932a412662c906f447/ff46a/logagent-howto-comma.png 325w,\n/static/1b8b99f7631939932a412662c906f447/a6d36/logagent-howto-comma.png 650w,\n/static/1b8b99f7631939932a412662c906f447/e548f/logagent-howto-comma.png 975w,\n/static/1b8b99f7631939932a412662c906f447/8d68c/logagent-howto-comma.png 1234w\"\n        sizes=\"(max-width: 650px) 100vw, 650px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>To edit systemd services I will use the righteous way of doing it. This way edits will survive Noah's Flood and the system update/upgrade.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo systemctl edit systemd-journal-upload</code></pre></div>\n<p>Add this content</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">[Unit]\nStartLimitIntervalSec=5\n\n[Service]\nWatchdogSec=0\nRestart=always\nTimeoutStartSec=1\nTimeoutStopSec=1\nStartLimitBurst=1000</code></pre></div>\n<p>Settings from the main file <code class=\"language-text\">/usr/lib/systemd/system/systemd-journal-upload.service</code> are used, except those that we just have overwritten.</p>\n<p>Be aware of \"recent\" systemd updates not reflected in the howto:</p>\n<blockquote>\n<p>StartLimitInterval was moved from [Service] to [Unit] section in 6bf0f408e4833152197fb38fb10a9989c89f3a59, but the old location was still accepted for compatibility. The new StartLimitIntervalSec name is valid only in [Unit].</p>\n</blockquote>\n<p>Reference: <a href=\"https://lists.freedesktop.org/archives/systemd-devel/2017-July/039255.html\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">https://lists.freedesktop.org/archives/systemd-devel/2017-July/039255.html</a></p>\n<p>Fire it up.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo systemctl enable systemd-journal-upload.service\nsudo systemctl start systemd-journal-upload.service</code></pre></div>\n<p>At this point your terminal with logagent should start spitting out all logs from systemd into the air. Stop it. Ctrl+C.</p>\n<p>Now it is time to tame the output with filters.</p>\n<h2 id=\"mockup-service\" style=\"position:relative;\">Mockup service<a href=\"#mockup-service\" aria-label=\"mockup service permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>As I said earlier, I only want to receive logs from one specific service. Like this simple <a href=\"/blog/why-do-i-hate-python\">Python</a> service: <a href=\"https://gist.github.com/mikolasan/917455a42152eeab24a0bb3fcb549647\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">https://gist.github.com/mikolasan/917455a42152eeab24a0bb3fcb549647</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">sudo mkdir /opt/my-python-project\nsudo chown $USER:$USER -R /opt/my-python-project\nvim /opt/my-python-project/main.py\nchmod +x /opt/my-python-project/main.py\n\nsudo vim /etc/systemd/system/my-python-project.service\nsudo systemctl start my-python-project</code></pre></div>\n<h2 id=\"fixing-bugs-in-logagent\" style=\"position:relative;\">Fixing bugs in logagent<a href=\"#fixing-bugs-in-logagent\" aria-label=\"fixing bugs in logagent permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>Instead of <code class=\"language-text\">include: !!js/regexp /.*/i</code>, should be one specific service, right? Like <code class=\"language-text\">include: !!js/regexp /my-python-project/i</code>.</p>\n<p>I actually see many many audit messages. They are not from my service. The thing about these messages - they do not have <code class=\"language-text\">_SYSTEMD_UNIT</code> attribute, hence it cannot be sorted out by any include/exclude logic.</p>\n<p>Next, if you are curious, I will give you a hint where the bug is in <code class=\"language-text\">journald-upload.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> _SYSTEMD_UNIT <span class=\"token operator\">=</span> <span class=\"token string\">'_systemd_unit'</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">[</span>_SYSTEMD_UNIT<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">.</span>_SYSTEMD_UNIT<span class=\"token punctuation\">)</span></code></pre></div>\n<p>I hope you already have that gut feeling.</p>\n<p>And how about unused function <code class=\"language-text\">parseLine</code>? I have started \"blaming\". And first thing I see:</p>\n<div class=\"gatsby-highlight\" data-language=\"diff\"><pre class=\"language-diff\"><code class=\"language-diff\"><span class=\"token inserted-sign inserted\"><span class=\"token prefix inserted\">+</span>  // fastest loop is counting down\n<span class=\"token prefix inserted\">+</span>  for (let i = lines.length; i >= 0 ; --i) {</span></code></pre></div>\n<blockquote>\n<p>fastest loop is counting down</p>\n</blockquote>\n<p>In JavaScript. I laughed.</p>\n<p>It was true on assembler level for Intel 8086. But current processors have parallel conveyers. I doubt that it is true in simple loops for modern compilers with <code class=\"language-text\">-O3</code>.</p>\n<p>At this point you may need to wait until all prevoius messages will be ignored. Also I did restart the <code class=\"language-text\">systemd-journal-upload</code> several times, I do not know if that helped. Also try to make a break, get a cup of tea and it will work eventually. That's my boss' favourite word: eventually.</p>\n<h2 id=\"add-filters\" style=\"position:relative;\">Add filters<a href=\"#add-filters\" aria-label=\"add filters permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>This part must be really straight forward. Just look at <a href=\"https://sematext.com/docs/logagent/input-filter-grep/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">the doc</a>. But no. The <code class=\"language-text\">journald-upload</code> input plugin  is not producing \"raw input\". It produces objects. Which means instead of input filters we must use otput filters. It is perfectly explained in ... comments in the source code.</p>\n<blockquote>\n<p>DATA_RAW events are emitted by input-plugins, producing text lines, and must be handled by text based input-filters and parser.</p>\n</blockquote>\n<blockquote>\n<p>DATA_OBJECT events are emitted by input plugins, producing structured data, with no need to be parsed. Such data needs to be processed by output-filters and output plugins. Skipping text based input filters and parser, and continue with directly output filters improves performance by saving serialisation to JSON and back to JS objects.</p>\n</blockquote>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">input</span><span class=\"token punctuation\">:</span>\n   <span class=\"token key atrule\">journal-upload</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">-</span>journald<span class=\"token punctuation\">-</span>upload\n    <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">9090</span>\n    <span class=\"token key atrule\">worker</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">systemdUnitFilter</span><span class=\"token punctuation\">:</span> \n      <span class=\"token key atrule\">include</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!!js/regexp</span> /my<span class=\"token punctuation\">-</span>python<span class=\"token punctuation\">-</span>project/i\n    <span class=\"token key atrule\">removeFields</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> __CURSOR\n      <span class=\"token punctuation\">-</span> _TRANSPORT\n      <span class=\"token punctuation\">-</span> _BOOT_ID\n      <span class=\"token punctuation\">-</span> _UID\n      <span class=\"token punctuation\">-</span> _GID\n      <span class=\"token punctuation\">-</span> _CAP_EFFECTIVE\n      <span class=\"token punctuation\">-</span> _MACHINE_ID\n      <span class=\"token punctuation\">-</span> _HOSTNAME\n      <span class=\"token punctuation\">-</span> _SYSTEMD_SLICE\n      <span class=\"token punctuation\">-</span> _STREAM_ID\n      <span class=\"token punctuation\">-</span> _PID\n      <span class=\"token punctuation\">-</span> _COMM\n      <span class=\"token punctuation\">-</span> _EXE\n      <span class=\"token punctuation\">-</span> _CMDLINE\n      <span class=\"token punctuation\">-</span> _SYSTEMD_CGROUP\n      <span class=\"token punctuation\">-</span> _SYSTEMD_INVOCATION_ID\n      <span class=\"token punctuation\">-</span> SYSLOG_FACILITY\n      <span class=\"token punctuation\">-</span> PRIORITY\n      <span class=\"token punctuation\">-</span> SYSLOG_IDENTIFIER\n\n<span class=\"token key atrule\">outputFilter</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">remove-fields</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> remove<span class=\"token punctuation\">-</span>fields\n    <span class=\"token key atrule\">matchSource</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!!js/regexp</span> .*\n    <span class=\"token key atrule\">fields</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> _systemd_unit\n  <span class=\"token key atrule\">dropEvents</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">module</span><span class=\"token punctuation\">:</span> drop<span class=\"token punctuation\">-</span>events\n    <span class=\"token key atrule\">debug</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">false</span>\n    <span class=\"token key atrule\">filters</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">message</span><span class=\"token punctuation\">:</span> \n        <span class=\"token key atrule\">exclude</span><span class=\"token punctuation\">:</span> <span class=\"token tag\">!!js/regexp</span> /bad/\n\n<span class=\"token key atrule\">output</span><span class=\"token punctuation\">:</span> \n  <span class=\"token key atrule\">stdout</span><span class=\"token punctuation\">:</span> yaml</code></pre></div>\n<p>When we add new <code class=\"language-text\">drop-events</code> filter, one can notice that developers like to debug with <code class=\"language-text\">console.log</code> and usually forget to remove it from production. I have a fix for that as well.</p>\n<h2 id=\"send-logs-to-slack\" style=\"position:relative;\">Send logs to Slack<a href=\"#send-logs-to-slack\" aria-label=\"send logs to slack permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<p>This part must be really straight forward. Just look at <a href=\"https://sematext.com/docs/logagent/output-plugin-slack/\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">the doc</a>. But no. Slack has new API for their <a href=\"https://api.slack.com/messaging/webhooks#advanced_message_formatting\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">fancy</a> <a href=\"https://api.slack.com/block-kit\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">Block Kit framework</a>.</p>\n<p>For the sake of a good example I will show how to print a timestamp from logs. It is not that easy as you think.</p>\n<p>Time from <code class=\"language-text\">journald-upload</code> is received in microseconds, it is not a Unix timestamp, but Slack <a href=\"https://api.slack.com/reference/surfaces/formatting#date-formatting\" target=\"_blank\" rel=\"external nofollow noopener noreferrer\">only understands</a> Unix timestamps. Somewhere in logagent we have to divide our value by 1000. So how to transform values in logagent? It doesn't seem hard to add a new plugin, but I will add transform function to <code class=\"language-text\">slack-webhook.js</code> and define it in <code class=\"language-text\">logagent.yml</code>.</p>\n<h2 id=\"results\" style=\"position:relative;\">Results<a href=\"#results\" aria-label=\"results permalink\" class=\"with-anchor after\"><svg aria-hidden=\"true\" height=\"20\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"20\">\n                <path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3\n                3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3\n                  9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64\n                  1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\">\n                </path>\n                </svg></a></h2>\n<ul>\n<li>Final <a href=\"/blog/logagent/logagent.yml\">config file</a></li>\n<li><a href=\"/blog/logagent/parse-systemd-and-post-in-slack.patch\">Patch</a> for <code class=\"language-text\">af1661efcb69812bc495524cbc07a1c55e0767ec</code> (tag <code class=\"language-text\">3.0.68</code>)</li>\n</ul>","excerpt":"I found logagent from a google search. It should solve a very simple thing: get logs from systemd, focus on one service, format a message…","tableOfContents":"<ul>\n<li><a href=\"#preface\">Preface</a></li>\n<li><a href=\"#install-logagent\">Install logagent</a></li>\n<li><a href=\"#configure-logagent\">Configure logagent</a></li>\n<li><a href=\"#send-systemd-logs-to-logagent\">Send systemd logs to logagent</a></li>\n<li><a href=\"#mockup-service\">Mockup service</a></li>\n<li><a href=\"#fixing-bugs-in-logagent\">Fixing bugs in logagent</a></li>\n<li><a href=\"#add-filters\">Add filters</a></li>\n<li><a href=\"#send-logs-to-slack\">Send logs to Slack</a></li>\n<li><a href=\"#results\">Results</a></li>\n</ul>","fields":{"socialcard":"gatsby-plugin-social-card/015e382f-044c-51ea-9b14-1cec72a3726c.jpg"},"frontmatter":{"date":"May 12, 2021","published":"October 14, 2021","lastModified":"July 31, 2022","title":"Send alerts from systemd to Slack","subtitle":null,"section":null,"draft":null,"developing":null,"buttonText":null,"buttonLink":null,"secondButtonText":null,"secondButtonLink":null,"featuredImage":null}}},"pageContext":{"showLikes":true,"absolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/parse-systemd-and-post-in-slack.md","url":"/blog/parse-systemd-and-post-in-slack","next":{"excerpt":"https://github.com/sematext/logagent-js/pull/277 After some old refactoring in  the function  became unused and still in the code, moreover…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/pull-requests-to-logagent.md","frontmatter":{"title":"My pull request to logagent.js","date":"2021-05-17T00:00:00.000Z","topic":null,"article":null},"id":"201005d6-06f4-5807-8174-4b0b5ec28603"},"previous":{"excerpt":"To succeed with this tutorial you will need to create an account in teamviewer first. It is better to do it from your host application. Then…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/remote-teamviewer-installation.md","frontmatter":{"title":"Remote TeamViewer installation","date":"2021-04-21T00:00:00.000Z","topic":null,"article":null},"id":"a8d9a2c8-c133-55c4-b41a-bbe8ce6d17cd"},"recentArticles":[{"excerpt":"To read AI hype is over? (post from 2023) - L’IA n’est-elle qu’un mythe qui s’essoufflera ? About Google alternative services -  Comment j…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/learning-french.md","frontmatter":{"title":"How I am learning French","date":"2025-07-12T00:00:00.000Z","topic":null,"article":null},"id":"de46ffde-c202-594f-b222-f5f4a548fbe4"},{"excerpt":"I think I like having a dialogue with someone who knows about the topic, even with students who just obtained knowledge from canonical…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/lizards-and-continuous-space.md","frontmatter":{"title":"Lizards and Continuous space","date":"2025-06-23T00:00:00.000Z","topic":null,"article":null},"id":"6ee1f95a-2c05-5950-8a0d-20ff4d937fb1"},{"excerpt":"Yes, developers add new features, refactor other parts to get rid of technical debt. This often changes API, which usually triggers…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/new-ui-and-conspiracy-in-it-industry.md","frontmatter":{"title":"New UI","date":"2025-06-21T00:00:00.000Z","topic":null,"article":null},"id":"fe2e710c-0afa-5b11-8a7d-1dc46d02f0f9"},{"excerpt":"Now when I almost finished with the titanic competition (I didn’t reach 90% accuracy as I planned, although I doubt it’s possible), it’s…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/regulus.md","frontmatter":{"title":"Regulus","date":"2025-05-13T00:00:00.000Z","topic":null,"article":null},"id":"cf23a6fc-e0e2-571b-9dbf-5030b3af25dd"},{"excerpt":"When I found out there was a popular platform where people share open source projects, I imagined GitHub differently. I thought I could find…","fileAbsolutePath":"/home/runner/work/mikolasan.github.io/mikolasan.github.io/src/markdown/blog/how-github-should-work.md","frontmatter":{"title":"How GitHub should work","date":"2025-04-03T00:00:00.000Z","topic":null,"article":null},"id":"63562cc8-f132-5cbc-a444-5639c4a78d98"}]}},"staticQueryHashes":["2961657013","447685113"],"slicesMap":{}}